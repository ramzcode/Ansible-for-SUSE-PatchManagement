---
- name: "Scan for Updates"
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: "Check if Updates available"
      shell: |
        zypper lu
      register: reg_update_check

    - name: "list update packages"
      shell: |
        zypper -x lu
        #zypper lu | sed -ne '/Reading installed packages.../,$ p' | sed '1,3d' | awk -F '|' '{ print $3, $4, $5, $6 }'
      register: list_package
      when: reg_update_check is not regex("No updates found")
    
        #    ##Need "xmltodict" pip install xmltodict
        #    - name: "debug"
        #      debug:
        #        msg: "{{list_package.stdout | ansible.utils.from_xml}}"

    - name: Create_JSON
      set_fact:
        list_pkg: "{{list_package.stdout | ansible.utils.from_xml | replace('-','_') | replace('@','')}}"

          #    - name: "debug"
          #      debug:
          #        msg: "{{list_pkg.stream.update_status.update_list | json_query('update[*].name')}}"

    - name: Create_FinalJSON
      set_fact:
        update_jsonlist: "{{list_pkg.stream.update_status.update_list}}"

    - name: "set available_updates UUI variable 1/2"
      set_fact:
        available_UUID:
          available_update_count: "{{ update_jsonlist | json_query('update[*].name') | list | length | int }}"

    - name: "debug"
      debug:
        msg: "{{available_UUID}}"

            #    - name: "list update packages"
            #      shell: |
            #        zypper -x lp
            #        #zypper lp --with-optional | sed -ne '/Reading installed packages.../,$ p' | sed '/^$/d' | sed '1,4d' | sed -e '/The following updates are also available:/,+2d' | sed -e '/^Found/,$d' | awk -F '|' '{ print $2, $3, $4, $8}'
            #      register: list_patch
            #      when: reg_update_check is not regex("No updates found")
            #
            #    - name: "debug"
            #      debug:
            #        msg: "{{list_patch.stdout | ansible.utils.from_xml}}"
